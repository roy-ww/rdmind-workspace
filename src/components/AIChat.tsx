import { useState, useRef, useEffect } from "react";
import { BookOpen } from "lucide-react";
import { ChatInput } from "@/components/ChatInput";
import { AIChatMessages, type ChatMessage } from "@/components/AIChatMessages";

const quickPrompts = ["å¿«é€Ÿç”Ÿæˆä»Šæ—¥æ—¥è®°", "æ€»ç»“æœ¬å‘¨é¡¹ç›®è¿›åº¦", "æ•´ç†çŸ¥è¯†åº“å†…å®¹"];

function generateDemoResponse(userText: string): ChatMessage[] {
  return [
    { type: "user", content: userText },
    {
      type: "thinking",
      content: `æ­£åœ¨åˆ†æç”¨æˆ·çš„é—®é¢˜ï¼š"${userText}"...\n\n1. ç†è§£ç”¨æˆ·æ„å›¾ä¸ä¸Šä¸‹æ–‡\n2. ç¡®å®šéœ€è¦è°ƒç”¨çš„å·¥å…·é“¾\n3. è§„åˆ’å¤šæ­¥éª¤æ‰§è¡Œæ–¹æ¡ˆ`,
    },
    {
      type: "ai",
      content: `å¥½çš„ï¼Œæˆ‘æ¥å¸®æ‚¨å¤„ç†è¿™ä¸ªé—®é¢˜ã€‚æˆ‘éœ€è¦å…ˆæŸ¥é˜…ä¸€äº›ç›¸å…³èµ„æ–™ã€‚`,
    },
    {
      type: "tool",
      content: "å¾…å¤„ç†ç¬”è®°.md",
      toolName: "è¯»å–æ–‡ä»¶",
      toolResult: "æˆåŠŸè¯»å–ï¼Œå…± 112 è¡Œ",
      toolDetail: "# å¾…å¤„ç†ç¬”è®°\n\n## æœ¬å‘¨å¾…åŠ\n- [ ] å®ŒæˆçŸ¥è¯†åº“æœç´¢åŠŸèƒ½ä¼˜åŒ–\n- [ ] ä¿®å¤ Markdown ç¼–è¾‘å™¨å…‰æ ‡é—®é¢˜\n- [x] å¯¹æ¥ AI å¯¹è¯æ¥å£\n- [ ] ç¼–å†™ Q2 è¿›åº¦æŠ¥å‘Š\n\n## å¤‡æ³¨\næŠ€æœ¯æ–¹æ¡ˆéœ€è¦åœ¨å‘¨ä¸‰å‰è¯„å®¡å®Œæˆï¼Œ\næ³¨æ„æ€§èƒ½ä¼˜åŒ–å’Œè¾¹ç•Œæƒ…å†µå¤„ç†ã€‚",
    },
    {
      type: "tool",
      content: "é¡¹ç›®A_è§„åˆ’.md",
      toolName: "æœç´¢çŸ¥è¯†åº“",
      toolResult: "åŒ¹é…åˆ° 3 ç¯‡ç›¸å…³æ–‡æ¡£",
      toolDetail: "åŒ¹é…ç»“æœï¼š\n1. é¡¹ç›®A_è§„åˆ’.md (ç›¸å…³åº¦ 0.95)\n   > é¡¹ç›®ç›®æ ‡ï¼šæ„å»ºä¼ä¸šçº§ AI çŸ¥è¯†ç®¡ç†å¹³å°...\n2. é¡¹ç›®A_æŠ€æœ¯é€‰å‹.md (ç›¸å…³åº¦ 0.87)\n   > å‰ç«¯æ¡†æ¶ï¼šReact + TypeScript...\n3. é¡¹ç›®A_é‡Œç¨‹ç¢‘.md (ç›¸å…³åº¦ 0.82)\n   > Q2 é‡Œç¨‹ç¢‘ï¼šå®Œæˆæ ¸å¿ƒåŠŸèƒ½ MVP...",
    },
    {
      type: "tool",
      content: "å‘¨æŠ¥_2024W22.md",
      toolName: "è¯»å–æ–‡ä»¶",
      toolResult: "æˆåŠŸè¯»å–ï¼Œå…± 58 è¡Œ",
      toolDetail: "# å‘¨æŠ¥ 2024-W22\n\n## æœ¬å‘¨å®Œæˆ\n- çŸ¥è¯†åº“ CRUD æ¥å£å¼€å‘\n- Markdown ç¼–è¾‘å™¨é›†æˆ\n- æ–‡ä»¶æ ‘ç»„ä»¶é‡æ„\n\n## ä¸‹å‘¨è®¡åˆ’\n- AI å¯¹è¯æ¨¡å—åŸå‹\n- è¯­ä¹‰æ£€ç´¢ä¼˜åŒ–\n- æ€§èƒ½å‹æµ‹",
    },
    {
      type: "tool",
      content: "æŠ€æœ¯æ–¹æ¡ˆ_v2.md",
      toolName: "è¯­ä¹‰æ£€ç´¢",
      toolResult: "ç›¸å…³åº¦ 0.92ï¼ŒåŒ¹é… 5 ä¸ªæ®µè½",
      toolDetail: "åŒ¹é…æ®µè½ï¼š\n\nÂ§1 æ¶æ„æ¦‚è¿°\n> ç³»ç»Ÿé‡‡ç”¨å‰åç«¯åˆ†ç¦»æ¶æ„ï¼Œå‰ç«¯ä½¿ç”¨ React...\n\nÂ§2 AI é›†æˆæ–¹æ¡ˆ\n> é€šè¿‡ Edge Function è°ƒç”¨å¤§æ¨¡å‹ APIï¼Œæ”¯æŒæµå¼è¾“å‡º...\n\nÂ§3 æ•°æ®å­˜å‚¨\n> ä½¿ç”¨å‘é‡æ•°æ®åº“å­˜å‚¨æ–‡æ¡£ embeddingï¼Œæ”¯æŒè¯­ä¹‰æœç´¢...\n\nÂ§4 å®‰å…¨è®¾è®¡\n> å®æ–½ RLS ç­–ç•¥ï¼Œç¡®ä¿å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»...\n\nÂ§5 æ€§èƒ½ä¼˜åŒ–\n> å‰ç«¯é‡‡ç”¨è™šæ‹Ÿæ»šåŠ¨ã€æ‡’åŠ è½½ç­‰ç­–ç•¥...",
    },
    {
      type: "ai",
      content: `æ ¹æ®æˆ‘æ£€ç´¢åˆ°çš„èµ„æ–™ï¼Œä¸ºæ‚¨æ•´ç†å¦‚ä¸‹ï¼š\n\n**æ ¸å¿ƒå‘ç°ï¼š**\n- é¡¹ç›®å½“å‰å¤„äº Q2 å¼€å‘é˜¶æ®µï¼Œæ ¸å¿ƒåŠŸèƒ½å¼€å‘è¿›åº¦çº¦ 60%\n- çŸ¥è¯†åº“ CRUD å’Œ Markdown ç¼–è¾‘å™¨å·²åŸºæœ¬å®Œæˆ\n- AI å¯¹è¯é›†æˆæ¨¡å—æ­£åœ¨å¼€å‘ä¸­`,
    },
    {
      type: "ai",
      content: `**å»ºè®®ä¸‹ä¸€æ­¥è¡ŒåŠ¨ï¼š**\n1. å®Œå–„è¯­ä¹‰æ£€ç´¢åŠŸèƒ½çš„æŠ€æœ¯æ–¹æ¡ˆ\n2. å¼€å§‹ AI å¯¹è¯æ¨¡å—çš„åŸå‹å¼€å‘\n3. å®‰æ’ä¸€æ¬¡æŠ€æœ¯è¯„å®¡ä¼šè®®\n4. è¡¥å……å•å…ƒæµ‹è¯•è¦†ç›–ç‡è‡³ 80% ä»¥ä¸Š`,
    },
    {
      type: "tool",
      content: "è¿›åº¦è·Ÿè¸ª_Q2.xlsx",
      toolName: "è¯»å–æ–‡ä»¶",
      toolResult: "æˆåŠŸè¯»å–ï¼Œå…± 24 è¡Œ",
      toolDetail: "| æ¨¡å—       | è´Ÿè´£äºº | è¿›åº¦  | çŠ¶æ€   |\n|-----------|--------|-------|--------|\n| çŸ¥è¯†åº“     | å¼ ä¸‰   | 85%   | è¿›è¡Œä¸­ |\n| AI å¯¹è¯    | æå››   | 40%   | è¿›è¡Œä¸­ |\n| ç¼–è¾‘å™¨     | ç‹äº”   | 90%   | æ”¶å°¾ä¸­ |\n| æ–‡ä»¶ç®¡ç†   | èµµå…­   | 70%   | è¿›è¡Œä¸­ |",
    },
    {
      type: "tool",
      content: "å›¢é˜Ÿæˆå‘˜_ä»»åŠ¡åˆ†é….md",
      toolName: "æœç´¢çŸ¥è¯†åº“",
      toolResult: "åŒ¹é…åˆ° 2 ç¯‡ç›¸å…³æ–‡æ¡£",
      toolDetail: "åŒ¹é…ç»“æœï¼š\n1. å›¢é˜Ÿæˆå‘˜_ä»»åŠ¡åˆ†é….md (ç›¸å…³åº¦ 0.91)\n   > å¼ ä¸‰ - çŸ¥è¯†åº“æ¨¡å— / æå›› - AI å¯¹è¯æ¨¡å—\n   > ç‹äº” - ç¼–è¾‘å™¨æ¨¡å— / èµµå…­ - æ–‡ä»¶ç®¡ç†\n2. å›¢é˜Ÿå‘¨ä¼šçºªè¦_W22.md (ç›¸å…³åº¦ 0.78)\n   > ä¼šè®®å†³è®®ï¼šæœ¬å‘¨é‡ç‚¹æ¨è¿› AI å¯¹è¯æ¨¡å—...",
    },
    {
      type: "ai",
      content: `ç»è¿‡è¿›ä¸€æ­¥åˆ†æï¼Œæˆ‘æ‰¾åˆ°äº†æ›´è¯¦ç»†çš„è¿›åº¦æ•°æ®ã€‚ä»¥ä¸‹æ˜¯å„æ¨¡å—çš„å®Œæˆæƒ…å†µï¼š`,
    },
    {
      type: "ai",
      content: `### ğŸ“Š é¡¹ç›®å„æ¨¡å—è¯¦ç»†è¿›åº¦æŠ¥å‘Š

| æ¨¡å—åç§° | è´Ÿè´£äºº | è®¡åˆ’å®Œæˆæ—¥æœŸ | å½“å‰è¿›åº¦ | çŠ¶æ€ |
|---------|--------|------------|---------|------|
| çŸ¥è¯†åº“ CRUD | å¼ ä¸‰ | 2024-06-15 | 95% | âœ… å³å°†å®Œæˆ |
| Markdown ç¼–è¾‘å™¨ | æå›› | 2024-06-20 | 88% | ğŸ”„ è¿›è¡Œä¸­ |
| AI å¯¹è¯é›†æˆ | ç‹äº” | 2024-07-10 | 45% | ğŸ”„ è¿›è¡Œä¸­ |
| è¯­ä¹‰æ£€ç´¢å¼•æ“ | èµµå…­ | 2024-07-05 | 60% | ğŸ”„ è¿›è¡Œä¸­ |
| ç”¨æˆ·æƒé™ç³»ç»Ÿ | å­™ä¸ƒ | 2024-06-30 | 72% | ğŸ”„ è¿›è¡Œä¸­ |
| æ–‡ä»¶å­˜å‚¨æœåŠ¡ | å‘¨å…« | 2024-06-25 | 80% | ğŸ”„ è¿›è¡Œä¸­ |
| æ•°æ®å¯è§†åŒ– | å´ä¹ | 2024-07-15 | 30% | âš ï¸ éœ€åŠ é€Ÿ |
| API ç½‘å…³ | éƒ‘å | 2024-07-01 | 55% | ğŸ”„ è¿›è¡Œä¸­ |

#### ğŸ“Œ å…³é”®é£é™©ç‚¹
- **æ•°æ®å¯è§†åŒ–æ¨¡å—**è¿›åº¦åæ…¢ï¼Œå»ºè®®å¢æ´¾äººæ‰‹æˆ–è°ƒæ•´ä¼˜å…ˆçº§
- **AI å¯¹è¯é›†æˆ**ä¾èµ–è¯­ä¹‰æ£€ç´¢å¼•æ“ï¼Œéœ€ç¡®ä¿åè€…æŒ‰æ—¶äº¤ä»˜
- æ•´ä½“é¡¹ç›®å¥åº·åº¦è¯„åˆ†ï¼š**7.5 / 10**

#### ğŸ’¡ ä¼˜åŒ–å»ºè®®
1. å°†ã€ŒçŸ¥è¯†åº“ CRUDã€çš„å‰©ä½™å·¥ä½œå°½å¿«æ”¶å°¾ï¼Œé‡Šæ”¾å¼ ä¸‰æ”¯æ´æ•°æ®å¯è§†åŒ–
2. è¯­ä¹‰æ£€ç´¢ä¸ AI å¯¹è¯ä¸¤ä¸ªæ¨¡å—å»ºè®®åšä¸€æ¬¡è”åˆæŠ€æœ¯è¯„å®¡ï¼Œå‡å°‘é›†æˆé£é™©
3. å»ºè®®æ¯å‘¨äº”å¢åŠ  30 åˆ†é’Ÿ stand-up ä¼šè®®ï¼Œèšç„¦è·¨æ¨¡å—ä¾èµ–é—®é¢˜

å¦‚éœ€äº†è§£æŸä¸ªæ¨¡å—çš„æ›´å¤šç»†èŠ‚ï¼Œæˆ–éœ€è¦æˆ‘ç”Ÿæˆç”˜ç‰¹å›¾ï¼Œè¯·éšæ—¶å‘Šè¯‰æˆ‘ã€‚`,
      resourceLink: {
        title: "ğŸ“„ é¡¹ç›®è¿›åº¦è¯¦ç»†æŠ¥å‘Š",
        content: `# é¡¹ç›®å„æ¨¡å—è¯¦ç»†è¿›åº¦æŠ¥å‘Š

## æ¦‚è§ˆ

é¡¹ç›®å½“å‰å¤„äº Q2 å¼€å‘é˜¶æ®µï¼Œæ•´ä½“è¿›åº¦çº¦ **65%**ï¼Œé¢„è®¡ 7 æœˆä¸­æ—¬å®Œæˆ MVPã€‚

---

## æ¨¡å—è¯¦æƒ…

### 1. çŸ¥è¯†åº“ CRUD â€” å¼ ä¸‰
- **è¿›åº¦**: 95%
- **è®¡åˆ’å®Œæˆ**: 2024-06-15
- **çŠ¶æ€**: âœ… å³å°†å®Œæˆ
- **è¯¦æƒ…**: åŸºç¡€å¢åˆ æ”¹æŸ¥å·²å®Œæˆï¼Œæ‰¹é‡æ“ä½œå’Œæƒé™æ§åˆ¶å¾…æ”¶å°¾ã€‚æ€§èƒ½æµ‹è¯•é€šè¿‡ï¼Œæ”¯æŒ 1000+ æ–‡æ¡£å¹¶å‘è¯»å†™ã€‚

### 2. Markdown ç¼–è¾‘å™¨ â€” æå››
- **è¿›åº¦**: 88%
- **è®¡åˆ’å®Œæˆ**: 2024-06-20
- **çŠ¶æ€**: ğŸ”„ è¿›è¡Œä¸­
- **è¯¦æƒ…**: æ‰€è§å³æ‰€å¾—æ¨¡å¼å·²å®Œæˆï¼Œä»£ç é«˜äº®å’Œè¡¨æ ¼ç¼–è¾‘å¾…ä¼˜åŒ–ã€‚å·²é›†æˆå›¾ç‰‡æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½ã€‚

### 3. AI å¯¹è¯é›†æˆ â€” ç‹äº”
- **è¿›åº¦**: 45%
- **è®¡åˆ’å®Œæˆ**: 2024-07-10
- **çŠ¶æ€**: ğŸ”„ è¿›è¡Œä¸­
- **è¯¦æƒ…**: åŸºç¡€å¯¹è¯æµå·²å®ç°ï¼Œæµå¼è¾“å‡ºå’Œå·¥å…·è°ƒç”¨æ­£åœ¨å¼€å‘ä¸­ã€‚ä¾èµ–è¯­ä¹‰æ£€ç´¢å¼•æ“çš„ API æ¥å£ã€‚

### 4. è¯­ä¹‰æ£€ç´¢å¼•æ“ â€” èµµå…­
- **è¿›åº¦**: 60%
- **è®¡åˆ’å®Œæˆ**: 2024-07-05
- **çŠ¶æ€**: ğŸ”„ è¿›è¡Œä¸­
- **è¯¦æƒ…**: å‘é‡å­˜å‚¨å’ŒåŸºç¡€æ£€ç´¢å·²å®Œæˆï¼Œæ··åˆæ£€ç´¢ï¼ˆå…³é”®è¯ + è¯­ä¹‰ï¼‰å’Œé‡æ’åºç®—æ³•æ­£åœ¨è°ƒè¯•ã€‚

### 5. ç”¨æˆ·æƒé™ç³»ç»Ÿ â€” å­™ä¸ƒ
- **è¿›åº¦**: 72%
- **è®¡åˆ’å®Œæˆ**: 2024-06-30
- **çŠ¶æ€**: ğŸ”„ è¿›è¡Œä¸­
- **è¯¦æƒ…**: åŸºäº RBAC çš„æƒé™æ¨¡å‹å·²å®Œæˆï¼Œå¤šç§Ÿæˆ·éš”ç¦»å’Œç»†ç²’åº¦æƒé™å¾…å®ç°ã€‚

### 6. æ–‡ä»¶å­˜å‚¨æœåŠ¡ â€” å‘¨å…«
- **è¿›åº¦**: 80%
- **è®¡åˆ’å®Œæˆ**: 2024-06-25
- **çŠ¶æ€**: ğŸ”„ è¿›è¡Œä¸­
- **è¯¦æƒ…**: æ–‡ä»¶ä¸Šä¼ ã€ä¸‹è½½ã€é¢„è§ˆå·²å®Œæˆã€‚å¤§æ–‡ä»¶åˆ†ç‰‡ä¸Šä¼ å’Œ CDN åŠ é€Ÿå¾…å¯¹æ¥ã€‚

### 7. æ•°æ®å¯è§†åŒ– â€” å´ä¹
- **è¿›åº¦**: 30%
- **è®¡åˆ’å®Œæˆ**: 2024-07-15
- **çŠ¶æ€**: âš ï¸ éœ€åŠ é€Ÿ
- **è¯¦æƒ…**: ä»…å®ŒæˆåŸºç¡€å›¾è¡¨ç»„ä»¶é€‰å‹ã€‚ä»ªè¡¨ç›˜å¸ƒå±€å’Œæ•°æ®èšåˆé€»è¾‘å°šæœªå¼€å§‹ã€‚**å»ºè®®å¢æ´¾äººæ‰‹**ã€‚

### 8. API ç½‘å…³ â€” éƒ‘å
- **è¿›åº¦**: 55%
- **è®¡åˆ’å®Œæˆ**: 2024-07-01
- **çŠ¶æ€**: ğŸ”„ è¿›è¡Œä¸­
- **è¯¦æƒ…**: è·¯ç”±è½¬å‘å’Œé‰´æƒä¸­é—´ä»¶å·²å®Œæˆï¼Œé™æµå’Œæ—¥å¿—ç›‘æ§å¾…å®ç°ã€‚

---

## é£é™©è¯„ä¼°

| é£é™©é¡¹ | ä¸¥é‡ç¨‹åº¦ | å½±å“èŒƒå›´ | ç¼“è§£æªæ–½ |
|-------|---------|---------|---------|
| æ•°æ®å¯è§†åŒ–è¿›åº¦æ»å | ğŸ”´ é«˜ | ä»ªè¡¨ç›˜åŠŸèƒ½ | å¢æ´¾äººæ‰‹ï¼Œç®€åŒ– MVP èŒƒå›´ |
| AI å¯¹è¯ä¾èµ–è¯­ä¹‰æ£€ç´¢ | ğŸŸ¡ ä¸­ | AI åŠŸèƒ½æ¨¡å— | è”åˆæŠ€æœ¯è¯„å®¡ï¼ŒMock æ¥å£å¹¶è¡Œå¼€å‘ |
| å¤šç§Ÿæˆ·æƒé™å¤æ‚åº¦ | ğŸŸ¡ ä¸­ | å…¨å±€å®‰å…¨ | åˆ†é˜¶æ®µå®æ–½ï¼Œå…ˆå•ç§Ÿæˆ·åå¤šç§Ÿæˆ· |

---

## å»ºè®®è¡ŒåŠ¨

1. **æœ¬å‘¨**ï¼šæ”¶å°¾çŸ¥è¯†åº“ CRUDï¼Œé‡Šæ”¾å¼ ä¸‰æ”¯æ´æ•°æ®å¯è§†åŒ–
2. **ä¸‹å‘¨**ï¼šè¯­ä¹‰æ£€ç´¢ + AI å¯¹è¯è”åˆè¯„å®¡
3. **æŒç»­**ï¼šæ¯å‘¨äº” 30 åˆ†é’Ÿ stand-upï¼Œèšç„¦è·¨æ¨¡å—ä¾èµ–

> æ•´ä½“é¡¹ç›®å¥åº·åº¦è¯„åˆ†ï¼š**7.5 / 10**`,
      },
    },
  ];
}

interface AIChatProps {
  className?: string;
  externalPrompt?: string;
  onExternalPromptConsumed?: () => void;
  onResourceClick?: (title: string, content: string) => void;
}

export function AIChat({ className, externalPrompt, onExternalPromptConsumed, onResourceClick }: AIChatProps) {
  const [chatMessages, setChatMessages] = useState<ChatMessage[]>([]);
  const [isStreaming, setIsStreaming] = useState(false);
  const chatEndRef = useRef<HTMLDivElement>(null);
  const abortRef = useRef(false);

  useEffect(() => {
    chatEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [chatMessages]);

  useEffect(() => {
    if (externalPrompt) {
      handleSend(externalPrompt);
      onExternalPromptConsumed?.();
    }
  }, [externalPrompt]);

  const isSendingRef = useRef(false);

  const handleSend = async (text: string) => {
    if (isSendingRef.current) return;
    isSendingRef.current = true;
    abortRef.current = false;
    setIsStreaming(true);
    const msgs = generateDemoResponse(text);
    for (const msg of msgs) {
      if (abortRef.current) break;
      setChatMessages((prev) => [...prev, msg]);
      await new Promise((r) => setTimeout(r, 500));
    }
    setIsStreaming(false);
    isSendingRef.current = false;
  };

  const handleStop = () => {
    abortRef.current = true;
  };

  const hasMessages = chatMessages.length > 0;

  return (
    <div className={className || "w-80 border-l border-border bg-sidebar flex flex-col shrink-0 h-full"}>
      {/* Header */}
      <div className="px-4 py-3 border-b border-border shrink-0">
        <div className="flex items-center gap-2">
          <div className="w-6 h-6 rounded-full brand-gradient flex items-center justify-center">
            <BookOpen className="h-3 w-3 text-primary-foreground" />
          </div>
          <span className="text-sm font-medium text-foreground">
            {hasMessages ? "å¯¹è¯ä¸­" : "å¼€å§‹å¯¹è¯"}
          </span>
        </div>
      </div>

      {/* Chat messages area */}
      <div className="flex-1 p-4 overflow-auto hide-scrollbar min-h-0">
        <AIChatMessages
          messages={chatMessages}
          ref={chatEndRef}
          isLoading={isStreaming}
          onResourceClick={onResourceClick}
        />
      </div>

      {/* Quick Prompt Chips */}
      <div className="px-4 pb-2 shrink-0">
        <div className="flex flex-wrap gap-1.5">
          {quickPrompts.map((prompt) => (
            <button
              key={prompt}
              onClick={() => handleSend(prompt)}
              className="px-2.5 py-1 rounded-full border border-border bg-card text-xs text-muted-foreground hover:bg-accent hover:text-foreground transition-colors"
            >
              {prompt}
            </button>
          ))}
        </div>
      </div>

      {/* Input pinned to bottom */}
      <div className="p-3 shrink-0">
        <ChatInput
          compact
          onSend={handleSend}
          placeholder="å‘é€æ¶ˆæ¯ç»™ Assistant"
          isLoading={isStreaming}
          onStop={handleStop}
        />
      </div>
    </div>
  );
}
